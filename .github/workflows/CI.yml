name: CI

on:
    push:
        branches:
            - "**"
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

env:
    SCYLLA_URI: "127.0.0.2:9042"
    SCYLLA_URI2: "127.0.0.3:9042"
    SCYLLA_URI3: "127.0.0.4:9042"

jobs:
    static-checks:
        name: Static Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  components: rustfmt, clippy

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.10

            - name: Run static checks on each commit
              run: |
                  for commit in $(git rev-list --reverse ${{ github.event.before }}..${{ github.sha }}); do
                      echo "::group::Static checks for $commit"
                      git checkout "$commit"
                      make static
                      echo "::endgroup::"
                  done

    tests:
        name: Tests
        runs-on: ubuntu-latest
        needs: static-checks
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Start ScyllaDB cluster
              run: make up

            - name: Wait for cluster to be ready
              run: |
                  for i in {1..30};
                  do docker ps | grep -q "unhealthy\|starting" &&
                  echo "Waiting for nodes... (attempt $i/30)" && sleep 1 ||
                  { echo "All nodes ready"; break; }; done

            - name: Run tests on each commit
              run: |
                  for commit in $(git rev-list --reverse ${{ github.event.before }}..${{ github.sha }}); do
                      echo "::group::Tests for $commit"
                      git checkout "$commit"
                      uv run --python 3.10 pytest -v
                      uv run --python 3.11 pytest -v
                      uv run --python 3.12 pytest -v
                      uv run --python 3.13 pytest -v
                      uv run --python 3.14 pytest -v
                      echo "::endgroup::"
                  done

            - name: Stop and cleanup ScyllaDB cluster
              if: always()
              run: |
                  make down
                  docker system prune -af --volumes
