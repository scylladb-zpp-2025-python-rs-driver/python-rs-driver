name: CI

on:
    push:
        branches:
            - "**"
    pull_request:
    workflow_dispatch:

permissions:
    contents: read

env:
    SCYLLA_URI: "127.0.0.2:9042"
    SCYLLA_URI2: "127.0.0.3:9042"
    SCYLLA_URI3: "127.0.0.4:9042"

jobs:
    static-checks:
        name: Static Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  components: rustfmt, clippy

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.10

            - name: Install Python dependencies
              run: uv sync --dev

            - name: Run static checks
              run: make static

    tests:
        name: Tests
        runs-on: ubuntu-latest
        needs: static-checks
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  components: rustfmt, clippy

            - name: Install uv
              uses: astral-sh/setup-uv@v3
              with:
                  enable-cache: true
                  cache-dependency-glob: "pyproject.toml"

            - name: Set up Python
              run: uv python install 3.10

            - name: Install Python dependencies
              run: uv sync --dev

            - name: Start ScyllaDB cluster
              run: make up

            - name: Wait for cluster to be ready
              run: |
                  for i in {1..30};
                  do docker ps | grep -q "unhealthy\|starting" &&
                  echo "Waiting for nodes... (attempt $i/30)" && sleep 1 ||
                  { echo "All nodes ready"; break; }; done

            - name: Run tests
              run: make test

            - name: Stop and cleanup ScyllaDB cluster
              if: always()
              run: |
                  make down
                  docker system prune -af --volumes
